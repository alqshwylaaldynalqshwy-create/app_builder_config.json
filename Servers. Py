import asyncio
import websockets
import json
import base64
from datetime import datetime

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
connected_clients = {}

async def handle_client(websocket, path):
    client_id = None
    
    try:
        async for message in websocket:
            data = json.loads(message)
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            if data['type'] == 'login':
                client_id = data['client_id']
                connected_clients[client_id] = websocket
                print(f"âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {client_id} Ù…ØªØµÙ„")
                
                # Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„
                await websocket.send(json.dumps({
                    'type': 'login_success',
                    'message': 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­'
                }))
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
            elif data['type'] == 'text_message':
                target_id = data['to']
                message_content = data['message']
                
                if target_id in connected_clients:
                    await connected_clients[target_id].send(json.dumps({
                        'type': 'text_message',
                        'from': client_id,
                        'message': message_content,
                        'timestamp': datetime.now().isoformat()
                    }))
                    print(f"ğŸ“¨ {client_id} â†’ {target_id}: {message_content}")
            
            # Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©
            elif data['type'] == 'image_message':
                target_id = data['to']
                image_data = data['image']  # base64 encoded
                
                if target_id in connected_clients:
                    await connected_clients[target_id].send(json.dumps({
                        'type': 'image_message',
                        'from': client_id,
                        'image': image_data,
                        'timestamp': datetime.now().isoformat()
                    }))
                    print(f"ğŸ–¼ï¸ {client_id} â†’ {target_id}: ØµÙˆØ±Ø©")
            
            # Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØª
            elif data['type'] == 'audio_message':
                target_id = data['to']
                audio_data = data['audio']  # base64 encoded
                
                if target_id in connected_clients:
                    await connected_clients[target_id].send(json.dumps({
                        'type': 'audio_message',
                        'from': client_id,
                        'audio': audio_data,
                        'timestamp': datetime.now().isoformat()
                    }))
                    print(f"ğŸ¤ {client_id} â†’ {target_id}: Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©")
    
    except websockets.exceptions.ConnectionClosed:
        print(f"âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {client_id} Ø§Ù†Ù‚Ø·Ø¹")
    finally:
        if client_id in connected_clients:
            del connected_clients[client_id]

async def main():
    server = await websockets.serve(handle_client, "0.0.0.0", 8765)
    print("ğŸš€ Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ws://localhost:8765")
    await server.wait_closed()

if __name__ == "__main__":
    asyncio.run(main())
